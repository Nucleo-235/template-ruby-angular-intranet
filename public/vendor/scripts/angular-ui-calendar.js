angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$locale",function(n,e){var a=n.eventSources,r=n.calendarWatchEvent?n.calendarWatchEvent:angular.noop,t=function(e){return function(){if(n.$root.$$phase)return e.apply(this,arguments);var a=arguments,r=this;return n.$root.$apply(function(){return e.apply(r,a)})}},l=1;this.eventFingerprint=function(n){n._id||(n._id=l++);var e=r({event:n})||"",a=moment.isMoment(n.start)?n.start.unix():n.start?moment(n.start).unix():"",t=moment.isMoment(n.end)?n.end.unix():n.end?moment(n.end).unix():"";return""+n._id+(n.id||"")+(n.title||"")+(n.url||"")+a+t+(n.allDay||"")+(n.className||"")+e};var o=1,u=1;this.sourceFingerprint=function(n){var e=""+(n.__id||(n.__id=o++)),a=angular.isObject(n)&&n.events;return a&&(e=e+"-"+(a.__id||(a.__id=u++))),e},this.allEvents=function(){for(var n=[],e=0,r=a.length;r>e;e++){var t=a[e];if(angular.isArray(t))n.push(t);else if(angular.isObject(t)&&angular.isArray(t.events)){var l={};for(var o in t)"_id"!==o&&"events"!==o&&(l[o]=t[o]);for(var u=0;u<t.events.length;u++)angular.extend(t.events[u],l);n.push(t.events)}}return Array.prototype.concat.apply([],n)},this.changeWatcher=function(n,e){var a,r=function(){for(var a,r,t=angular.isFunction(n)?n():n,o=[],u=0,i=t.length;i>u;u++)r=t[u],a=e(r),l[a]=r,o.push(a);return o},t=function(n,e){var a,r,t=[],l={};for(a=0,r=e.length;r>a;a++)l[e[a]]=!0;for(a=0,r=n.length;r>a;a++)l[n[a]]||t.push(n[a]);return t},l={},o=function(n,r){var o,u,i,d,c={},f=t(r,n);for(o=0,u=f.length;u>o;o++){var s=f[o];i=l[s],delete l[s];var v=e(i);v===s?a.onRemoved(i):(c[v]=s,a.onChanged(i))}var g=t(n,r);for(o=0,u=g.length;u>o;o++)d=g[o],i=l[d],c[d]||a.onAdded(i)};return a={subscribe:function(n,e){n.$watch(r,function(n,a){var r=!(e&&e(n,a)===!1);r&&o(n,a)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(n,e){var a={};return angular.extend(a,e),angular.extend(a,n),angular.forEach(a,function(n,e){"function"==typeof n&&(a[e]=t(a[e]))}),a},this.getLocaleConfig=function(n){if(!n.lang||n.useNgLocale){var a=function(n){var e,a;e=[];for(a in n)e[a]=n[a];return e},r=e.DATETIME_FORMATS;return{monthNames:a(r.MONTH),monthNamesShort:a(r.SHORTMONTH),dayNames:a(r.DAY),dayNamesShort:a(r.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(n){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(e,a,r,t){function l(){var a,l=r.uiCalendar?e.$parent.$eval(r.uiCalendar):{};a=t.getFullCalendarConfig(l,n);var o=t.getLocaleConfig(a);angular.extend(o,a),f={eventSources:u},angular.extend(f,o),f.calendars=null;var i={};for(var d in f)"eventSources"!==d&&(i[d]=f[d]);return JSON.stringify(i)}var o,u=e.eventSources,i=!1,d=t.changeWatcher(u,t.sourceFingerprint),c=t.changeWatcher(t.allEvents,t.eventFingerprint),f=null;e.destroyCalendar=function(){o&&o.fullCalendar&&o.fullCalendar("destroy"),o=r.calendar?n.calendars[r.calendar]=$(a).html(""):$(a).html("")},e.initCalendar=function(){o||(o=angular.element(a).html("")),o.fullCalendar(f),r.calendar&&(n.calendars[r.calendar]=o)},e.$on("$destroy",function(){e.destroyCalendar()}),d.onAdded=function(e){o&&o.fullCalendar&&(o.fullCalendar(f),r.calendar&&(n.calendars[r.calendar]=o),o.fullCalendar("addEventSource",e),i=!0)},d.onRemoved=function(n){o&&o.fullCalendar&&(o.fullCalendar("removeEventSource",n),i=!0)},d.onChanged=function(){o&&o.fullCalendar&&(o.fullCalendar("refetchEvents"),i=!0)},c.onAdded=function(n){o&&o.fullCalendar&&o.fullCalendar("renderEvent",n,n.stick?!0:!1)},c.onRemoved=function(n){o&&o.fullCalendar&&o.fullCalendar("removeEvents",n._id)},c.onChanged=function(n){if(o&&o.fullCalendar)for(var e=o.fullCalendar("clientEvents",n._id),a=0;a<e.length;a++){var r=e[a];r=angular.extend(r,n),o.fullCalendar("updateEvent",r)}},d.subscribe(e),c.subscribe(e,function(){return i===!0?(i=!1,!1):void 0}),e.$watch(l,function(n,a){n!==a?(e.destroyCalendar(),e.initCalendar()):n&&angular.isUndefined(o)&&e.initCalendar()})}}}]);